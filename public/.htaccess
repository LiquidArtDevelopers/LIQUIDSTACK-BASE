RewriteEngine On

# Si viene con www y vamos a sin www
RewriteCond %{HTTP_HOST} !^bazkide\.atleticosansebastian\.com$ [NC]
RewriteRule ^ https://bazkide.atleticosansebastian.com%{REQUEST_URI} [R=301,L]

# Si viene por http pasamos a https
RewriteCond %{HTTPS} !=on
RewriteCond %{HTTP:X-Forwarded-Proto} !https [NC]
RewriteCond %{HTTP:CF-Visitor} !https [NC]
RewriteCond %{HTTP:Forwarded} !proto=https [NC]
RewriteRule ^ https://bazkide.atleticosansebastian.com%{REQUEST_URI} [R=301,L]

# quitamos la / del final (excepto en la raíz) y sin afectar a archivos/dir reales
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.+)/$ /$1 [R=301,L]

# que no cuente como url los files y directory
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Evitar descarga de archivos en esta carpeta con una redirección 403
RedirectMatch 403 ^/php/files/.*$

# carga ese archivo como enroutador
RewriteRule ^ index.php [L,QSA]


# reglas de seguridad de apache
<IfModule mod_security2.c>
        SecRuleRemoveById 201 210580 211220 211230 214940 218130
</IfModule>


# Políticas de caché para activos estáticos cuando no está disponible Varnish
<IfModule mod_expires.c>
    ExpiresActive On

    # Cacheo prolongado para recursos multimedia y fuentes
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg  "access plus 1 year"
    ExpiresByType image/png  "access plus 1 year"
    ExpiresByType image/gif  "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/avif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType video/mp4  "access plus 1 year"
    ExpiresByType video/webm "access plus 1 year"
    ExpiresByType video/ogg  "access plus 1 year"

    ExpiresByType font/ttf   "access plus 1 year"
    ExpiresByType font/otf   "access plus 1 year"
    ExpiresByType font/woff  "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"

    # Hojas de estilo y scripts con duración intermedia
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"

    # Valor por defecto
    ExpiresDefault "access plus 1 week"
</IfModule>

<IfModule mod_headers.c>
    # Reglas de cache-control alineadas con los expires anteriores
    <FilesMatch "\.(?:ico|gif|jpe?g|png|webp|avif|svg|mp4|webm|ogg|mp3|m4v|mov|ttf|otf|eot|woff2?)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    <FilesMatch "\.(?:css|js)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>

    <FilesMatch "\.(?:html|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </FilesMatch>
</IfModule>
